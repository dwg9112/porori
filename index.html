<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Maple HUD Widget</title>
<style>
  html,body{ margin:0; background:transparent; }

  :root{
    --scale: 1;              /* OBS에서 전체 크기 조절 (예: 1.2) */
    --hudW: calc(1280px * var(--scale));
    --hudH: calc(86px * var(--scale));
    --font: "Malgun Gothic","Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;
    --shadow: rgba(0,0,0,0.9);
  }

  /* 전체 캔버스 */
  .stage{
    width: var(--hudW);
    height: var(--hudH);
    position: relative;
    overflow: hidden;
  }

  /* 네가 자른 하단 HUD 스킨 */
  .skin{
    position:absolute; inset:0;
    background: url("./hud.png") no-repeat;
    background-size: 100% 100%;
    image-rendering: auto;
    pointer-events:none;
  }

  /* 글자 스타일(스샷 느낌으로 살짝 두껍게) */
  .txt{
    position:absolute;
    font-family: var(--font);
    font-weight: 800;
    font-size: calc(14px * var(--scale));
    color: #f5f5f5;
    text-shadow:
      1px 1px 0 var(--shadow),
      -1px 1px 0 var(--shadow),
      1px -1px 0 var(--shadow),
      -1px -1px 0 var(--shadow);
    white-space:nowrap;
    user-select:none;
  }

  /* 게이지(색만 덮어씌우기) */
  .barMask{
    position:absolute;
    overflow:hidden;        /* 스킨 위에서 막(마스크) 역할 */
    border-radius: 2px;
  }
  .barFill{
    height:100%;
    width:100%;
    transform-origin:left center;
    transform: scaleX(1);
  }

  /* 스샷 느낌 색감 */
  .hpFill{ background: linear-gradient(180deg,#ff7d7d,#d13f3f); }
  .mpFill{ background: linear-gradient(180deg,#7aa6ff,#2f69d6); }
  .expFill{ background: linear-gradient(180deg,#b7ff6e,#55c52b); }

  /* ====== 좌표 튜닝 구역 ======
     hud.png 를 "1280x86" 정도로 잘랐다는 가정으로
     아래 좌표를 맞춰두었어.
     만약 너의 hud.png 크기가 다르면,
     이 좌표만 살짝 움직이면 1:1로 딱 맞는다.
  */

  /* LV 숫자(왼쪽 LV 박스 안) */
  #lv { left: calc(78px * var(--scale)); top: calc(52px * var(--scale)); transform: translate(-50%,-50%); }

  /* 직업/닉네임(왼쪽 중앙) */
  #job { left: calc(150px * var(--scale)); top: calc(44px * var(--scale)); }
  #nick{ left: calc(150px * var(--scale)); top: calc(62px * var(--scale)); }

  /* HP/MP/EXP 숫자 위치(바 오른쪽 텍스트) */
  #hpText { left: calc(395px * var(--scale)); top: calc(44px * var(--scale)); }
  #mpText { left: calc(395px * var(--scale)); top: calc(62px * var(--scale)); }
  #expText{ left: calc(620px * var(--scale)); top: calc(53px * var(--scale)); transform: translateY(-50%); }

  /* 바 마스크 영역(스킨의 바 위치에 맞춰 덮어칠 영역) */
  #hpMask { left: calc(210px * var(--scale)); top: calc(40px * var(--scale)); width: calc(170px * var(--scale)); height: calc(10px * var(--scale)); }
  #mpMask { left: calc(210px * var(--scale)); top: calc(58px * var(--scale)); width: calc(170px * var(--scale)); height: calc(10px * var(--scale)); }
  #expMask{ left: calc(470px * var(--scale)); top: calc(49px * var(--scale)); width: calc(140px * var(--scale)); height: calc(10px * var(--scale)); transform: translateY(-50%); }

  /* (선택) 클릭 방지 */
  .stage *{ pointer-events:none; }
</style>
</head>

<body>
<div class="stage">
  <!-- 게이지 색(스킨 아래/위는 취향. 보통 스킨 "아래"에 두면 이질감 줄어듦) -->
  <div class="barMask" id="hpMask"><div class="barFill hpFill" id="hpFill"></div></div>
  <div class="barMask" id="mpMask"><div class="barFill mpFill" id="mpFill"></div></div>
  <div class="barMask" id="expMask"><div class="barFill expFill" id="expFill"></div></div>

  <!-- 스킨 -->
  <div class="skin"></div>

  <!-- 텍스트 오버레이 -->
  <div class="txt" id="lv">107</div>

  <div class="txt" id="job">배달파트너</div>
  <div class="txt" id="nick">포로리왓썰</div>

  <div class="txt" id="hpText">250 / 250</div>
  <div class="txt" id="mpText">250 / 250</div>
  <div class="txt" id="expText">EXP. 0 [0.00%]</div>
</div>

<script>
(() => {
  const STORAGE_KEY = "porori_maple_hud_save_v1";

  // 규칙: 시간당 EXP +1, 100%면 레벨업, 레벨업 시 HP/MP Max +50
  const expPerHour = 1;
  const expNeeded = 100;
  const expPerMs = expPerHour / 3600000;

  const defaultState = {
    level: 1,
    hpMax: 250, mpMax: 250,
    exp: 0,
    lastTs: Date.now()
  };

  const $ = (id) => document.getElementById(id);

  let state = load();

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultState);
      const s = { ...structuredClone(defaultState), ...JSON.parse(raw) };
      s.level = Math.max(1, Math.floor(s.level||1));
      s.hpMax = Math.max(1, Math.floor(s.hpMax||250));
      s.mpMax = Math.max(1, Math.floor(s.mpMax||250));
      s.exp = Math.max(0, Number(s.exp||0));
      s.lastTs = Number(s.lastTs||Date.now());
      return s;
    }catch{
      return structuredClone(defaultState);
    }
  }

  function save(){
    state.lastTs = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function pad3(n){ return String(n).padStart(3,"0"); }

  function levelUpIfNeeded(){
    while(state.exp >= expNeeded){
      state.exp -= expNeeded;
      state.level += 1;
      state.hpMax += 50;
      state.mpMax += 50;
    }
  }

  function applyOffline(){
    const now = Date.now();
    const dt = Math.max(0, now - state.lastTs);
    const gained = dt * expPerMs;
    if(gained > 0){
      state.exp += gained;
      levelUpIfNeeded();
      save();
    }
  }

  function render(){
    // 표시값(HP/MP는 항상 Max로 표기)
    const hp = state.hpMax;
    const mp = state.mpMax;

    // LV
    $("lv").textContent = pad3(state.level);

    // 숫자
    $("hpText").textContent = `${hp} / ${state.hpMax}`;
    $("mpText").textContent = `${mp} / ${state.mpMax}`;

    const pct = Math.min(100, (state.exp/expNeeded)*100);
    const expShown = Math.floor(state.exp*100)/100;
    $("expText").textContent = `EXP. ${expShown.toFixed(2)} [${pct.toFixed(2)}%]`;

    // 바
    $("hpFill").style.transform  = `scaleX(1)`; // 항상 만땅
    $("mpFill").style.transform  = `scaleX(1)`; // 항상 만땅
    $("expFill").style.transform = `scaleX(${pct/100})`;
  }

  // 시작: 오프라인 진행 반영
  applyOffline();
  render();

  // 실시간 누적
  let last = performance.now();
  let lastSave = performance.now();

  function tick(now){
    const dt = now - last;
    last = now;

    state.exp += dt * expPerMs;
    levelUpIfNeeded();
    render();

    if(now - lastSave > 5000){
      save();
      lastSave = now;
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
