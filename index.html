<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MapleLand Bottom UI Widget</title>
<style>
  :root{
    --scale: 1;               /* 전체 크기 조절 */
    --w: calc(1280px * var(--scale));
    --h: calc(86px * var(--scale));

    --frame1:#cfd3d8;
    --frame2:#8f969e;
    --inner1:#3a3f45;
    --inner2:#22262b;

    --text:#f3f6fb;
    --shadow:#0b0d10;

    --hp:#d84a4a;
    --mp:#3a74d6;
    --exp:#7fd34a;

    --thin: 1px;
    --r: 6px;

    --font: "Malgun Gothic","Apple SD Gothic Neo","Noto Sans KR",system-ui,sans-serif;
  }

  html,body{ margin:0; background:transparent; }
  .wrap{
    width:var(--w);
    height:var(--h);
    display:flex;
    align-items:flex-end;
    justify-content:center;
  }

  /* 메탈 프레임 느낌 */
  .frame{
    width: calc(var(--w) - 8px);
    height: calc(var(--h) - 8px);
    background: linear-gradient(180deg, var(--frame1), #b6bcc3 40%, var(--frame2));
    border-radius: var(--r);
    box-shadow:
      0 2px 10px rgba(0,0,0,0.35),
      0 0 0 2px rgba(0,0,0,0.25) inset;
    padding: 6px;
    box-sizing:border-box;
  }

  .panel{
    width:100%;
    height:100%;
    background: linear-gradient(180deg, var(--inner1), var(--inner2));
    border-radius: calc(var(--r) - 2px);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.12) inset,
      0 0 0 2px rgba(0,0,0,0.35) inset;
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 8px 10px;
    box-sizing:border-box;
    font-family: var(--font);
    color: var(--text);
    text-shadow: 1px 1px 0 var(--shadow);
  }

  /* LV 박스 */
  .lvBox{
    width: calc(92px * var(--scale));
    height: calc(58px * var(--scale));
    border-radius: 6px;
    background: linear-gradient(180deg,#1f2328,#101316);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.08) inset,
      0 0 0 2px rgba(0,0,0,0.45) inset;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    gap: 4px;
    flex: 0 0 auto;
  }
  .lvLabel{
    font-weight:800;
    font-size: calc(12px * var(--scale));
    color:#d8dde6;
    opacity:0.9;
    letter-spacing:0.5px;
  }
  .lvValue{
    font-weight:900;
    font-size: calc(18px * var(--scale));
    color:#ffd98a;
    letter-spacing:0.8px;
  }

  /* 이름 영역(메이플처럼 2줄) */
  .nameBlock{
    width: calc(250px * var(--scale));
    display:flex;
    flex-direction:column;
    gap: 2px;
    flex: 0 0 auto;
  }
  .nameLine1{
    font-weight:800;
    font-size: calc(14px * var(--scale));
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .nameLine2{
    font-weight:800;
    font-size: calc(13px * var(--scale));
    color:#cbd6ff;
    opacity:0.95;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* 스탯 영역 */
  .stats{
    display:flex;
    flex-direction:column;
    gap: 6px;
    flex: 1 1 auto;
    min-width: 0;
  }

  .row{
    display:flex;
    align-items:center;
    gap: 8px;
    min-width:0;
  }

  .tag{
    width: calc(38px * var(--scale));
    text-align:right;
    font-weight:900;
    font-size: calc(13px * var(--scale));
    opacity:0.95;
  }

  .bar{
    position:relative;
    height: calc(10px * var(--scale));
    flex: 1 1 auto;
    min-width: 140px;
    border-radius: 4px;
    background: rgba(255,255,255,0.08);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.12) inset,
      0 0 0 2px rgba(0,0,0,0.35) inset;
    overflow:hidden;
  }
  .fill{
    position:absolute;
    inset:0;
    transform-origin:left center;
    transform: scaleX(1);
  }
  .hpFill{ background: linear-gradient(180deg, #ff7a7a, var(--hp)); }
  .mpFill{ background: linear-gradient(180deg, #6aa0ff, var(--mp)); }
  .expFill{ background: linear-gradient(180deg, #b6ff86, var(--exp)); }

  .nums{
    width: calc(140px * var(--scale));
    font-variant-numeric: tabular-nums;
    font-weight:900;
    font-size: calc(13px * var(--scale));
    text-align:left;
    white-space:nowrap;
  }

  .expText{
    width: calc(190px * var(--scale));
    text-align:left;
    font-variant-numeric: tabular-nums;
    font-weight:900;
    font-size: calc(13px * var(--scale));
    white-space:nowrap;
  }

  /* 옵션 버튼(원하면 지워도 됨) */
  .controls{
    display:flex;
    flex-direction:column;
    gap:6px;
    flex: 0 0 auto;
  }
  .btn{
    font-size: 12px;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(0,0,0,0.22);
    color:#fff;
    cursor:pointer;
    user-select:none;
  }
  .btn:hover{ background: rgba(0,0,0,0.35); }
</style>
</head>

<body>
<div class="wrap">
  <div class="frame">
    <div class="panel">
      <div class="lvBox">
        <div class="lvLabel">LV.</div>
        <div class="lvValue" id="lvText">001</div>
      </div>

      <div class="nameBlock">
        <div class="nameLine1" id="line1">배달파트너</div>
        <div class="nameLine2" id="line2">포로리</div>
      </div>

      <div class="stats">
        <div class="row">
          <div class="tag">HP</div>
          <div class="bar"><div class="fill hpFill" id="hpFill"></div></div>
          <div class="nums" id="hpNums">250/250</div>
        </div>
        <div class="row">
          <div class="tag">MP</div>
          <div class="bar"><div class="fill mpFill" id="mpFill"></div></div>
          <div class="nums" id="mpNums">250/250</div>
        </div>
        <div class="row">
          <div class="tag">EXP</div>
          <div class="bar"><div class="fill expFill" id="expFill"></div></div>
          <div class="expText" id="expText">0 [0.00%]</div>
        </div>
      </div>

      <div class="controls">
        <div class="btn" id="btnRename">이름 수정</div>
        <div class="btn" id="btnReset">초기화</div>
      </div>

    </div>
  </div>
</div>

<script>
(() => {
  const STORAGE_KEY = "porori_maple_bottom_ui_v1";

  // 규칙
  const expPerHour = 1;            // 시간당 EXP +1
  const expNeeded = 100;           // 100이면 100%
  const expPerMs = expPerHour / 3600000;

  const defaultState = {
    title: "배달파트너",
    name: "포로리",
    level: 1,

    hpMax: 250,
    mpMax: 250,
    hp: 250,
    mp: 250,

    exp: 0,          // 0~100
    lastTs: Date.now()
  };

  const $ = (id) => document.getElementById(id);
  const lvText = $("lvText");
  const line1 = $("line1");
  const line2 = $("line2");
  const hpFill = $("hpFill");
  const mpFill = $("mpFill");
  const expFill = $("expFill");
  const hpNums = $("hpNums");
  const mpNums = $("mpNums");
  const expText = $("expText");

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultState);
      const obj = JSON.parse(raw);
      const s = { ...structuredClone(defaultState), ...obj };

      s.level = Math.max(1, Math.floor(s.level || 1));
      s.hpMax = Math.max(1, Math.floor(s.hpMax || 250));
      s.mpMax = Math.max(1, Math.floor(s.mpMax || 250));
      s.hp = s.hpMax;
      s.mp = s.mpMax;

      s.exp = Math.max(0, Number(s.exp || 0));
      s.lastTs = Number(s.lastTs || Date.now());
      return s;
    }catch{
      return structuredClone(defaultState);
    }
  }

  function saveState(){
    state.lastTs = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function pad3(n){
    return String(Math.max(0, Math.floor(n))).padStart(3,"0");
  }

  function handleLevelUps(){
    while(state.exp >= expNeeded){
      state.exp -= expNeeded;
      state.level += 1;
      state.hpMax += 50;
      state.mpMax += 50;
      state.hp = state.hpMax;
      state.mp = state.mpMax;
    }
  }

  function applyOfflineProgress(){
    const now = Date.now();
    const dt = Math.max(0, now - state.lastTs);
    const gained = dt * expPerMs;
    if(gained > 0){
      state.exp += gained;
      handleLevelUps();
      state.hp = state.hpMax;
      state.mp = state.mpMax;
      saveState();
    }
  }

  function updateUI(){
    lvText.textContent = pad3(state.level);

    line1.textContent = state.title;
    line2.textContent = state.name;

    hpNums.textContent = `${state.hp}/${state.hpMax}`;
    mpNums.textContent = `${state.mp}/${state.mpMax}`;

    hpFill.style.transform = `scaleX(${state.hpMax ? state.hp/state.hpMax : 0})`;
    mpFill.style.transform = `scaleX(${state.mpMax ? state.mp/state.mpMax : 0})`;

    const pct = Math.min(100, (state.exp / expNeeded) * 100);
    expFill.style.transform = `scaleX(${pct/100})`;

    const expDisplay = Math.floor(state.exp * 100) / 100;
    expText.textContent = `${expDisplay.toFixed(2)} [${pct.toFixed(2)}%]`;
  }

  // 버튼
  $("btnRename").addEventListener("click", () => {
    const title = prompt("타이틀(예: 배달파트너)", state.title);
    if(title === null) return;
    const name = prompt("이름(예: 포로리)", state.name);
    if(name === null) return;

    state.title = (title || "").trim() || state.title;
    state.name = (name || "").trim() || state.name;
    saveState();
    updateUI();
  });

  $("btnReset").addEventListener("click", () => {
    if(!confirm("정말 초기화할까? (레벨/스탯/경험치 전부 초기화)")) return;
    state = structuredClone(defaultState);
    saveState();
    updateUI();
  });

  // 시작: 오프라인 진행분 반영 후 실시간 루프
  applyOfflineProgress();
  updateUI();

  let lastFrame = performance.now();
  let lastSave = performance.now();

  function tick(now){
    const dt = now - lastFrame;
    lastFrame = now;

    state.exp += dt * expPerMs;
    handleLevelUps();

    // 항상 만땅
    state.hp = state.hpMax;
    state.mp = state.mpMax;

    updateUI();

    if(now - lastSave > 5000){
      saveState();
      lastSave = now;
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
